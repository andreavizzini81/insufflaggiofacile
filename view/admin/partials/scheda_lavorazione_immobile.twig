{% set metadata = data.deal.getMetadata() %}
{% set immobile = metadata.immobile %}
<form class="widget build-data-wrapper" data-id="{{ data.deal.getId() }}">
    <div class="content" id="contentToPrint">
		<fieldset class="mb-3">
			<legend>SCHEDA IMMOBILE</legend>
			<div class="row">
				<div class="col-12 col-lg-6 mb-3">
					<div class="form-group">
						<label class="control-label">Scegli la tipologia dell'immobile</label>
						<div class="input-group mb-1">
							<div class="input-group-text">
								<input class="form-check-input mt-0 field" type="radio" name="tipo_immobile" value="Appartamento" {{ immobile.tipo_immobile == 'Appartamento' ? 'checked' : '' }} required>
							</div>
							<input type="text" class="form-control" placeholder="Appartamento" disabled>
						</div>
						<div class="input-group mb-1">
							<div class="input-group-text">
								<input class="form-check-input mt-0 field" type="radio" name="tipo_immobile" value="Villa" {{ immobile.tipo_immobile == 'Villa' ? 'checked' : '' }}>
							</div>
							<input type="text" class="form-control" placeholder="Villa" disabled>
						</div>
						<div class="input-group">	
							<div class="input-group-text">
								<input class="form-check-input mt-0 field" type="radio" name="tipo_immobile" value="Altro" {{ immobile.tipo_immobile == 'Altro' ? 'checked' : '' }}>
							</div>
							<input type="text" class="form-control" placeholder="Altro" disabled>
							<input type="text" class="form-control" name="tipo_immobile_altro" value="{{ immobile.tipo_immobile_altro != '' ? immobile.tipo_immobile_altro : '' }}"  placeholder="Se altro, scrivi quì cosa">
						</div>
					</div>
				</div>
				<div class="col-12 col-lg-6 mb-3">
					<div class="form-group">
						<label>Quale materiale si deve insufflare?</label>
						<select class="form-control" name="materiale_da_insufflare">
							<option value="">Scegli il materiale da insufflare</option>
							<option value="Cellulosa" {{ immobile.materiale_da_insufflare == 'Cellulosa' ? 'selected' : '' }}>Cellulosa</option>
							<option value="Lana di vetro" {{ immobile.materiale_da_insufflare == 'Lana di vetro' ? 'selected' : '' }}>Lana di vetro</option>
							<option value="Lana di roccia" {{ immobile.materiale_da_insufflare == 'Lana di roccia' ? 'selected' : '' }}>Lana di roccia</option>
							<option value="Sughero" {{ immobile.materiale_da_insufflare == 'Sughero' ? 'selected' : '' }}>Sughero</option>
						</select>
					</div>
				</div>
				<div class="col-12 col-lg-6 mb-3">
					<div class="form-group">
						<label class="control-label">Cosa si deve insufflare?</label>
						<div class="input-group mb-1">
							<div class="input-group-text">
								<input class="form-check-input mt-0 field"  type="checkbox" name="cosa_insufflare_1" value="Pareti perimetrali" {{ immobile.cosa_insufflare_1 == 'Pareti perimetrali' ? 'checked' : '' }} required>
							</div>
							<input type="text" class="form-control" placeholder="Pareti perimetrali" disabled>
						</div>
						<div class="input-group mb-1">
							<div class="input-group-text">
								<input class="form-check-input mt-0 field" type="checkbox" name="cosa_insufflare_2" value="Sottotetto" {{ immobile.cosa_insufflare_2 == 'Sottotetto' ? 'checked' : '' }}>
							</div>
							<input type="text" class="form-control" placeholder="Sottotetto" disabled>
						</div>
						<div class="input-group">
							<div class="input-group-text">
								<input class="form-check-input mt-0 field" type="checkbox" name="cosa_insufflare_3" value="Controsoffitto" {{ immobile.cosa_insufflare_3 == 'Controsoffitto' ? 'checked' : '' }}>
							</div>
							<input type="text" class="form-control" placeholder="Controsoffitto" disabled>
						</div>
					</div>
				</div>
				<div class="col-12 col-lg-6 mb-3">
					<div class="form-group">
						<label class="control-label">Esiste già un isolante nell'intercapedine?</label>
						<div class="input-group mb-1">
							<div class="input-group-text">
								<input class="form-check-input mt-0 field"  type="radio" name="isolante_preesistente" value="Si" {{ immobile.isolante_preesistente == 'Si' ? 'checked' : '' }} required>
							</div>
							<input type="text" class="form-control" placeholder="Si" disabled>
						</div>
						<div class="input-group mb-1">
							<div class="input-group-text">
								<input class="form-check-input mt-0 field" type="radio" name="isolante_preesistente" value="No" {{ immobile.isolante_preesistente == 'No' ? 'checked' : '' }}>
							</div>
							<input type="text" class="form-control" placeholder="No" disabled>
						</div>
						<div class="input-group">
							<div class="input-group-text">
								<input class="form-check-input mt-0 field" type="radio" name="isolante_preesistente" value="Non so" {{ immobile.isolante_preesistente == 'Non so' ? 'checked' : '' }}>
							</div>
							<input type="text" class="form-control" placeholder="Non so" disabled>
						</div>
					</div>
				</div>
			</div>
			<div class="row psc cosa_insufflare_1 m-3 bg-info rounded">
				{% include '/partials/lavorazione_pareti.twig' %}
			</div>
			<div class="row psc cosa_insufflare_2 m-3 bg-info rounded">
				{% include '/partials/lavorazione_sottotetto.twig' %}
			</div>
			<div class="row psc cosa_insufflare_3 m-3 bg-info rounded">
				{% include '/partials/lavorazione_controsoffitto.twig' %}
			</div>
			<div class="row">
				<div class="d-grid gap-2 mt-2">
				  <button class="btn btn-success save-building-sheet" type="button"><span class="fad fa-check "></span>&nbsp;&nbsp;Salva scheda immobile</button>
				</div>
			</div>
			<div class="row">
				<div class="d-grid gap-2 mt-2">
				  <button class="btn btn-warning print-building-sheet" type="button"><span class="fad fa-check "></span>&nbsp;&nbsp;Stampa scheda</button>
				</div>
			</div>
		</fieldset> 
	</div>
</form>
<script>
    document.addEventListener('DOMContentLoaded', function() {

        Delegate(document).on('click', '.save-building-sheet', function() {
            const form = document.querySelector('.build-data-wrapper');
			const dealId = form.dataset.id;
            this.classList.add('loading');
			console.log(FormSerializer.for(form).serialize());
            HttpRequest.patch(`${res.absolutePath}api/deal-build-sheet/${dealId}`, FormSerializer.for(form).serialize(), (data, response) => {
                if (data.status !== 1) {
                    throw data.message ?? 'Errore generico';
                }
               window.location = `${res.path}deal/${dealId}`;
            }, err => void new ResAlert('Operazione fallita', err.toString(), {type:'error'}));
        });
		
		function formatKey(key) {
			if (key.includes('_')) {
				return key.split('_').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
			} else {
				return key.replace(/([A-Z])/g, ' $1').trim();
			}
		}
		
		Delegate(document).on('click', '.print-building-sheet', function() {
			const form = document.querySelector('.build-data-wrapper');
			const formSerialized = FormSerializer.for(form).serialize();
			const finestraDiStampa = window.open('', '', 'width=800, height=600');
			finestraDiStampa.document.write('<html><head><title>Contenuto da Stampare</title></head><body><table>');
			for (const key in formSerialized) {
				const value = formSerialized[key];
				if (!value) continue;
				const formattedKey = formatKey(key);
				finestraDiStampa.document.write(`<tr><td>${formattedKey}</td><td>${value}</td></tr>`);
			}
		
			finestraDiStampa.document.write('</table></body></html>');
			finestraDiStampa.document.close();
			finestraDiStampa.print();
		});
		
		function ciOpenClose(num) {
			const selettore = document.querySelector('.cosa_insufflare_' + num );
			const cosaInsufflareSelsector = document.querySelector('[name="cosa_insufflare_'+num+'"]');
			const edAll = selettore.querySelectorAll("input.field, select.field, textarea.field, button.field");
			console.log(cosaInsufflareSelsector.checked);
			if(cosaInsufflareSelsector.checked){
				const cosaInsufflare = cosaInsufflareSelsector.value.toLowerCase().replace(/ /g, "-");
				selettore.style.height = "100%";
				selettore.classList.remove('invisible');
				edAll.forEach(function(el) {
					el.disabled = false;
				});
			} else {
				selettore.style.height = "0px"
				selettore.classList.add('invisible');
				edAll.forEach(function(el) {
					el.disabled = true;
				});
			}
		}

		for(let i=1;i<=3;i++){
			Delegate(document).on('change', '[name="cosa_insufflare_' + i + '"]', () => {
				ciOpenClose(i);
			});
			ciOpenClose(i);
		}

    });
</script>