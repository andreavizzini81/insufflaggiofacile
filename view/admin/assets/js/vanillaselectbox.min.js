let VSBoxCounter = function () {
    let count = 0;
    let instances = [];
    return {
        set: function (instancePtr) {
            instances.push({ offset: ++count, ptr: instancePtr });
            return instances[instances.length - 1].offset;
        },
        remove: function (instanceNr) {
            let temp = instances.filter(function (x) {
                return x.offset != instanceNr;
            })
            instances = temp.splice(0);
        },
        closeAllButMe: function (instanceNr) {
            instances.forEach(function (x) {
                if (x.offset != instanceNr) {
                    x.ptr.closeOrder();
                }
            });
        }
    };
}();

function vanillaSelectBox(rootElement, options) {
    let self = this;
    this.instanceOffset = VSBoxCounter.set(self);
    this.root = (rootElement instanceof HTMLSelectElement) 
        ? rootElement 
        : document.querySelector(rootElement);
    this.root['vanillaSelectBox'] = this;
    if (!this.root || !this.root.multiple) {
        throw 'Invalid target element';
    }
    this.rootToken = null;
    this.main;
    this.button;
    this.title;
    this.multipleSize = -1;
    this.isOptgroups = false;
    this.drop;
    this.top;
    this.left;
    this.options;
    this.listElements;
    this.isDisabled = false;
    this.inputBox = null;
    this.disabledItems = [];
    this.ulminWidth = 140;
    this.ulmaxWidth = 1000;
    this.ulminHeight = 25;
    this.maxOptionWidth = Infinity;
    this.maxSelect = Infinity;
    this.onInit = null;
    this.onInitSize = null;
    this.forbidenAttributes = ['class', 'selected', 'disabled', 'data-text', 'data-value', 'style'];
    this.forbidenClasses = ['active', 'disabled'];
    this.userOptions = {
        maxWidth: 1000,
        minWidth: -1,
        maxHeight: 300,
        translations: {
            all: 'All', 
            item: 'item', 
            items: 'items', 
            selectAll: 'Select All'
        },
        placeHolder: '',
        stayOpen: false,
        selectAll: true,
        buttonItemsSeparator: ', '
    }
    this.keepInlineStyles = true;
    if (options) {
        if (options.itemsSeparator != undefined) {
            this.userOptions.buttonItemsSeparator = options.itemsSeparator;
        }
        if (options.maxWidth != undefined) {
            this.userOptions.maxWidth = options.maxWidth;
        }
        if (options.minWidth != undefined) {
            this.userOptions.minWidth = options.minWidth;
        }
        if (options.maxHeight != undefined) {
            this.userOptions.maxHeight = options.maxHeight;
        }
        if (options.translations != undefined) {
            for (var property in options.translations) {
                if (options.translations.hasOwnProperty(property)) {
                    if (this.userOptions.translations[property]) {
                        this.userOptions.translations[property] = options.translations[property];
                    }
                }
            }
        }
        if (options.placeHolder != undefined) {
            this.userOptions.placeHolder = options.placeHolder;
        }

        if (options.stayOpen != undefined) {
            this.userOptions.stayOpen = options.stayOpen;
        }

        if (options.selectAll != undefined) {
            this.userOptions.selectAll = options.selectAll;
        }

        if (options.maxSelect != undefined && !isNaN(options.maxSelect) && options.maxSelect >= 1) {
            this.maxSelect = options.maxSelect;
            this.userOptions.selectAll = false;
        }

        if (options.maxOptionWidth != undefined && !isNaN(options.maxOptionWidth) && options.maxOptionWidth >= 20) {
            this.maxOptionWidth = options.maxOptionWidth;
            this.ulminWidth = options.maxOptionWidth + 60;
            this.ulmaxWidth = options.maxOptionWidth + 60;
        }

        if (options.keepInlineStyles != undefined) {
            this.keepInlineStyles = options.keepInlineStyles;
        }
        
        if (options.multipleSize != undefined) {
            this.multipleSize = options.multipleSize;
        }

    }

    this.closeOrder = function () {
        let self = this;
        if (!self.userOptions.stayOpen) {
            self.drop.style.visibility = 'hidden';
        }
    }

    this.init = function () {
        self.createTree();
        this.checkUncheckAll();
    }

    this.getResult = function () {
        let self = this;
        let result = [];
        let collection = self.root.querySelectorAll('option');
        collection.forEach(function (x) {
            if (x.selected) {
                result.push(x.value);
            }
        });
        return result;
    }

    this.createTree = function () {

        this.rootToken = self.root.name.replace(/[^A-Za-z0-9_]+/g, '');
        this.root.classList.add('vsb-native-select-hidden');
        let already = document.getElementById(`btn-group-${this.rootToken}`);
        if (already) {
            already.remove();
        }
        this.main = document.createElement('div');
        this.root.parentNode.insertBefore(this.main, this.root.nextSibling);
        this.main.classList.add('vsb-main');
        this.main.setAttribute('id', `btn-group-${this.rootToken}`);
        this.main.style.marginLeft = this.main.style.marginLeft;
        if (self.userOptions.stayOpen) {
            this.main.style.minHeight = (this.userOptions.maxHeight + 10) + 'px';
        }

        if (self.userOptions.stayOpen) {
            this.button = document.createElement('div');
        } else {
            this.button = document.createElement('button');
        }
        this.button.style.maxWidth = this.userOptions.maxWidth + 'px';
        if (this.userOptions.minWidth !== -1) {
            this.button.style.minWidth = this.userOptions.minWidth + 'px';
        }

        this.main.appendChild(this.button);
        this.title = document.createElement('span');
        this.button.appendChild(this.title);
        this.title.classList.add('title');

        this.drop = document.createElement('div');
        this.main.appendChild(this.drop);
        this.drop.classList.add('vsb-menu');
        this.drop.style.zIndex = 2000 - this.instanceOffset;
        this.ul = document.createElement('ul');
        this.drop.appendChild(this.ul);

        this.ul.style.maxHeight = this.userOptions.maxHeight + 'px';
        this.ul.style.minWidth = this.ulminWidth + 'px';
        this.ul.style.maxWidth = this.ulmaxWidth + 'px';
        this.ul.style.minHeight = this.ulminHeight + 'px';
        if (self.userOptions.selectAll) {
            let selectAll = document.createElement('option');
            selectAll.setAttribute('value', 'all');
            selectAll.innerText = self.userOptions.translations.selectAll;
            this.root.insertBefore(selectAll, (this.root.hasChildNodes())
                ? this.root.childNodes[0]
                : null);
        }
        let selectedTexts = ''
        let sep = '';
        let nrActives = 0;

        this.options = Array.from(this.root.querySelectorAll(':scope > option'));
        this.options.forEach(function (x) {
            let text = x.textContent;
            let value = x.value;
            let originalAttrs;
            if (x.hasAttributes()) {
                originalAttrs = Array.prototype.slice.call(x.attributes)
                    .filter(function (a) {
                        return self.forbidenAttributes.indexOf(a.name) === -1
                    });
            }
            let classes = x.getAttribute('class');
            if (classes) {
                classes = classes
                    .split(' ')
                    .filter(function (c) {
                        return self.forbidenClasses.indexOf(c) === -1
                    });
            } else {
                classes = [];
            }
            let li = document.createElement('li');
            let isSelected = x.hasAttribute('selected');
            li.classList.toggle('disabled', x.disabled);

            self.ul.appendChild(li);
            li.setAttribute('data-value', value);
            li.setAttribute('data-text', text);

            if (originalAttrs !== undefined) {
                originalAttrs.forEach(function (a) {
                    li.setAttribute(a.name, a.value);
                });
            }

            classes.forEach(function (x) {
                li.classList.add(x);
            });

            if (self.maxOptionWidth < Infinity) {
                li.classList.add('short');
                li.style.maxWidth = self.maxOptionWidth + 'px';
            }

            if (isSelected) {
                nrActives++;
                selectedTexts += sep + text;
                sep = self.userOptions.buttonItemsSeparator;
                li.classList.add('active');
            }
            li.innerHTML = `<span>${text}</span>`;
        });

        let groups = this.root.querySelectorAll('optgroup');   
        if (groups.length > 0) {
            self.isOptgroups = true;
            self.options = Array.from(this.root.options);
            Array.prototype.slice.call(groups).forEach(function(group, index) {
                self.ul.insertAdjacentHTML('beforeend', `<li class="grouped-option" id="${self.rootToken}-opt-${index}" data-text="${group.label}" ${group.hidden ? 'hidden' : ''}>${group.label}</li>`);
                Array.prototype.slice.call(group.children).forEach(function(_option) {
                    let classes = Array.from(_option.classList);
                    let li = document.createElement('li');
                    li.dataset.value = _option.value;
                    li.dataset.text = _option.textContent;
                    li.dataset.parent = `${self.rootToken}-opt-${index}`;
                    if (_option.selected) {
                        nrActives++;
                        selectedTexts += sep + _option.textContent;
                        sep = self.userOptions.buttonItemsSeparator;
                        classes.push('active');
                    }
                    if (group.disabled || _option.disabled) {
                        classes.push('disabled');
                    }
                    classes.forEach(function(item) {
                        li.classList.add(item);
                    });
                    li.hidden = group.hidden;
                    li.innerHTML = `<span>${_option.textContent}</span>`;
                    self.ul.appendChild(li);
                })
            });
        }

        let optionsLength = self.options.length - Number(self.userOptions.selectAll);

        if (optionsLength == nrActives) {
            selectedTexts = self.userOptions.translations.all;
        } else if (self.multipleSize != -1) {
            if (nrActives > self.multipleSize) {
                let wordForItems = nrActives === 1 ? self.userOptions.translations.item : self.userOptions.translations.items;
                selectedTexts = nrActives + ' ' + wordForItems;
            }
        }

        self.title.innerHTML = selectedTexts;
        if (self.userOptions.placeHolder != '' && self.title.textContent == '') {
            self.title.textContent = self.userOptions.placeHolder;
        }
        self.listElements = self.drop.querySelectorAll('li:not(.grouped-option)');

        if (self.userOptions.stayOpen) {
            self.drop.style.visibility = 'visible';
            self.drop.style.boxShadow = 'none';
            self.drop.style.minHeight = (this.userOptions.maxHeight + 10) + 'px';
            self.drop.style.position = 'relative';
            self.drop.style.left = '0px';
            self.drop.style.top = '0px';
            self.button.style.border = 'none';
        } else {
            this.main.addEventListener('click', function (e) {
                if (self.isDisabled) return;
                self.drop.style.visibility = 'visible';
                document.addEventListener('click', docListener);
                e.preventDefault();
                e.stopPropagation();
                if (!self.userOptions.stayOpen) {
                    VSBoxCounter.closeAllButMe(self.instanceOffset);
                }
            });
        }

        this.drop.addEventListener('click', function (e) {
            if (self.isDisabled) return;
            if (e.target.tagName === 'INPUT') return;
            let isShowHideCommand = e.target.tagName === 'SPAN';
            let isCheckCommand = e.target.tagName === 'I';
            let liClicked = e.target.parentElement;
            if (!liClicked.hasAttribute('data-value')) {
                if (liClicked.classList.contains('grouped-option')) {
                    if (!isShowHideCommand && !isCheckCommand) return;
                    let oldClass, newClass;
                    if (isCheckCommand) { // check or uncheck children
                        self.checkUncheckFromParent(liClicked);
                    } else { //open or close
                        if (liClicked.classList.contains('open')) {
                            oldClass = 'open';
                            newClass = 'closed';
                        } else {
                            oldClass = 'closed';
                            newClass = 'open';
                        }
                        liClicked.classList.remove(oldClass);
                        liClicked.classList.add(newClass);
                        let theChildren = self.drop.querySelectorAll(`[data-parent="${liClicked.id}"]`);
                        theChildren.forEach(function (x) {
                            x.classList.remove(oldClass);
                            x.classList.add(newClass);
                        })
                    }
                    return;
                }
            }
            let choiceValue = e.target.getAttribute('data-value');
            let className = e.target.getAttribute('class');

            if (className && className.indexOf('disabled') != -1) {
                return;
            }

            if (className && className.indexOf('overflow') != -1) {
                return;
            }

            if (choiceValue === 'all') {
                if (e.target.hasAttribute('data-selected') && e.target.getAttribute('data-selected') === 'true') {
                    self.setValue('none')
                } else {
                    self.setValue('all');
                }
                return;
            }

            let wasActive = false;
            if (className) {
                wasActive = className.indexOf('active') != -1;
            }
            if (wasActive) {
                e.target.classList.remove('active');
            } else {
                e.target.classList.add('active');
            }
            if (e.target.hasAttribute('data-parent')) {
                self.checkUncheckFromChild(e.target);
            }

            let selectedTexts = ''
            let sep = '';
            let nrActives = 0;
            let nrAll = 0;
            for (let i = 0; i < self.options.length; i++) {
                nrAll++;
                if (self.options[i].value == choiceValue) {
                    self.options[i].selected = !wasActive;
                }
                if (self.options[i].selected) {
                    nrActives++;
                    selectedTexts += sep + self.options[i].textContent;
                    sep = self.userOptions.buttonItemsSeparator;
                }
            }
            if (nrAll == nrActives - Number(self.userOptions.selectAll)) {
                let wordForAll = self.userOptions.translations.all;
                selectedTexts = wordForAll;
            } else if (self.multipleSize != -1) {
                if (nrActives > self.multipleSize) {
                    let wordForItems = nrActives === 1 ? self.userOptions.translations.item : self.userOptions.translations.items;
                    selectedTexts = nrActives + ' ' + wordForItems;
                }
            }
            self.title.textContent = selectedTexts;
            self.checkSelectMax(nrActives);
            self.checkUncheckAll();
            self.privateSendChange();
            e.preventDefault();
            e.stopPropagation();
            if (self.userOptions.placeHolder != '' && self.title.textContent == '') {
                self.title.textContent = self.userOptions.placeHolder;
            }
        });
        function docListener() {
            document.removeEventListener('click', docListener);
            self.drop.style.visibility = 'hidden';
        }
    }
    this.init();
    
}

vanillaSelectBox.prototype.buildSelect = function (data) {
    let self = this;
    if (data == null || data.length < 1) return;
    if (!self.isOptgroups) {
        self.isOptgroups = data[0].parent != undefined && data[0].parent != '';
    }

    if (self.isOptgroups) {
        let groups = {};
        data = data.filter(function (x) {
            return x.parent != undefined && x.parent != '';
        });

        data.forEach(function (x) {
            if (!groups[x.parent]) {
                groups[x.parent] = true;
            }
        });
        for (let group in groups) {
            let anOptgroup = document.createElement('optgroup');
            anOptgroup.setAttribute('label', group);

            options = data.filter(function (x) {
                return x.parent == group;
            });
            options.forEach(function (x) {
                let anOption = document.createElement('option');
                anOption.value = x.value;
                anOption.text = x.text;
                if (x.selected) {
                    anOption.setAttribute('selected', true)
                }
                anOptgroup.appendChild(anOption);
            });
            self.root.appendChild(anOptgroup);
        }
    } else {
        data.forEach(function (x) {
            let anOption = document.createElement('option');
            anOption.value = x.value;
            anOption.text = x.text;
            if (x.selected) {
                anOption.setAttribute('selected', true)
            }
            self.root.appendChild(anOption);
        });
    }
}

vanillaSelectBox.prototype.optionsCheckedToData = function () {
    let self = this;
    let dataChecked = [];
    let treeOptions = self.ul.querySelectorAll('li.active:not(.grouped-option)');
    let keepParents = {};
    if (treeOptions) {
        Array.prototype.slice.call(treeOptions).forEach(function (x) {
            let oneData = {
                value: x.getAttribute('data-value'), 
                text: x.getAttribute('data-text'), 
                selected: true
            };
            if (oneData.value !== 'all') {
                if (self.isOptgroups) {
                    let parentId = x.getAttribute('data-parent');
                    if (keepParents[parentId] != undefined) {
                        oneData.parent = keepParents[parentId];
                    } else {
                        let parentPtr = self.ul.querySelector('#' + parentId);
                        let parentName = parentPtr.getAttribute('data-text');
                        keepParents[parentId] = parentName;
                        oneData.parent = parentName;
                    }
                }
                dataChecked.push(oneData);
            }
        });
    }
    return dataChecked;
}

vanillaSelectBox.prototype.checkSelectMax = function (nrActives) {
    let self = this;
    if (self.maxSelect == Infinity) return;
    if (self.maxSelect <= nrActives) {
        Array.prototype.slice.call(self.listElements).forEach(function (x) {
            if (x.hasAttribute('data-value')) {
                if (!x.classList.contains('disabled') && !x.classList.contains('active')) {
                    x.classList.add('overflow');
                }
            }
        });
    } else {
        Array.prototype.slice.call(self.listElements).forEach(function (x) {
            if (x.classList.contains('overflow')) {
                x.classList.remove('overflow');
            }
        });
    }
}

vanillaSelectBox.prototype.checkUncheckFromChild = function (liClicked) {
    let self = this;
    let parentId = liClicked.getAttribute('data-parent');
    let parentLi = document.getElementById(parentId);
    let listElements = self.drop.querySelectorAll('li');
    let childrenElements = Array.prototype.slice.call(listElements).filter(function (el) {
        return el.hasAttribute('data-parent') && el.getAttribute('data-parent') == parentId && !el.classList.contains('hidden-search');
    });
    let nrChecked = 0;
    let nrCheckable = childrenElements.length;
    if (nrCheckable == 0) return;
    childrenElements.forEach(function (el) {
        if (el.classList.contains('active')) nrChecked++;
    });
    if (nrChecked === nrCheckable || nrChecked === 0) {
        if (nrChecked === 0) {
            parentLi.classList.remove('checked');
        } else {
            parentLi.classList.add('checked');
        }
    } else {
        parentLi.classList.remove('checked');
    }
}

vanillaSelectBox.prototype.checkUncheckFromParent = function (liClicked) {
    let self = this;
    let parentId = liClicked.id;
    let listElements = self.drop.querySelectorAll('li');
    let childrenElements = Array.prototype.slice.call(listElements).filter(function (el) {
        return el.hasAttribute('data-parent') && el.getAttribute('data-parent') == parentId && !el.classList.contains('hidden-search');
    });
    let nrChecked = 0;
    let nrCheckable = childrenElements.length;
    if (nrCheckable == 0) return;
    childrenElements.forEach(function (el) {
        if (el.classList.contains('active')) nrChecked++;
    });
    if (nrChecked === nrCheckable || nrChecked === 0) {
        childrenElements.forEach(function (el) {
            var event = document.createEvent('HTMLEvents');
            event.initEvent('click', true, false);
            el.dispatchEvent(event);
        });
        if (nrChecked === 0) {
            liClicked.classList.add('checked');
        } else {
            liClicked.classList.remove('checked');
        }
    } else {
        liClicked.classList.remove('checked');
        childrenElements.forEach(function (el) {
            if (!el.classList.contains('active')) {
                var event = document.createEvent('HTMLEvents');
                event.initEvent('click', true, false);
                el.dispatchEvent(event);
            }
        });
    }
}

vanillaSelectBox.prototype.checkUncheckAll = function () {
    let self = this;
    let nrChecked = 0;
    let nrCheckable = 0;
    let totalAvailableElements = 0;
    let checkAllElement = null;
    if (self.listElements == null) return;
    Array.prototype.slice.call(self.listElements).forEach(function (x) {
        if (x.hasAttribute('data-value')) {
            if (x.getAttribute('data-value') === 'all') {
                x.classList.add('check-all');
                checkAllElement = x;
            }
            if (x.getAttribute('data-value') !== 'all'
                && !x.classList.contains('hidden-search')
                && !x.classList.contains('disabled')) {
                nrCheckable++;
                nrChecked += x.classList.contains('active');
            }
            if (x.getAttribute('data-value') !== 'all'
                && !x.classList.contains('disabled')) {
                totalAvailableElements++;
            }
        }
    });

    if (checkAllElement) {
        if (nrChecked === nrCheckable) {
            if (nrChecked === totalAvailableElements) {
                self.title.innerHTML = `<span>${self.userOptions.translations.all}</span>`;
                checkAllElement.classList.add('active');
                checkAllElement.innerHTML = `<span>${self.userOptions.translations.selectAll}</span>`;
                checkAllElement.setAttribute('data-selected', 'true')
            }
        } else if (nrChecked === 0) {
            self.title.textContent = self.userOptions.placeHolder;
            checkAllElement.classList.remove('active');
            checkAllElement.innerHTML = `<span>${self.userOptions.translations.selectAll}</span>`;
            checkAllElement.setAttribute('data-selected', 'false')
        }
    }
}

vanillaSelectBox.prototype.setValue = function (values) {
    let self = this;
    let listElements = self.drop.querySelectorAll('li');

    if (values == null || values == undefined || values == '') {
        self.empty();
    } else {
        if (vanillaSelectBox_type(values) == 'string') {
            if (values === 'all') {
                values = [];
                Array.prototype.slice.call(listElements).forEach(function (x) {
                    if (x.hasAttribute('data-value')) {
                        let value = x.getAttribute('data-value');
                        if (value !== 'all') {
                            if (!x.classList.contains('hidden-search') && !x.classList.contains('disabled')) {
                                values.push(x.getAttribute('data-value'));
                            }
                            if (x.classList.contains('active')) {
                                if (x.classList.contains('hidden-search') || x.classList.contains('disabled')) {
                                    values.push(value);
                                }
                            }
                        } else {
                            x.classList.add('active');
                        }
                    } else if (x.classList.contains('grouped-option')) {
                        x.classList.add('checked');
                    }
                });
            } else if (values === 'none') {
                values = [];
                Array.prototype.slice.call(listElements).forEach(function (x) {
                    if (x.hasAttribute('data-value')) {
                        let value = x.getAttribute('data-value');
                        if (value !== 'all') {
                            if (x.classList.contains('active')) {
                                if (x.classList.contains('hidden-search') || x.classList.contains('disabled')) {
                                    values.push(value);
                                }
                            }
                        }
                    } else if (x.classList.contains('grouped-option')) {
                        x.classList.remove('checked');
                    }
                });
            } else {
                values = values.split(',');
            }
        }
        let foundValues = [];
        if (vanillaSelectBox_type(values) == 'array') {
            Array.prototype.slice.call(self.options).forEach(function (x) {
                if (values.indexOf(x.value) !== -1) {
                    x.selected = true;
                    foundValues.push(x.value);
                } else {
                    x.selected = false;
                }
            });
            let selectedTexts = '';
            let sep = '';
            let nrActives = 0;
            let nrAll = 0;
            Array.prototype.slice.call(listElements).forEach(function (x) {
                if (x.value !== 'all') {
                    nrAll++;
                }
                if (foundValues.indexOf(x.getAttribute('data-value')) != -1) {
                    x.classList.add('active');
                    nrActives++;
                    selectedTexts += sep + x.getAttribute('data-text');
                    sep = self.userOptions.buttonItemsSeparator;
                } else {
                    x.classList.remove('active');
                }
            });
            if (nrAll == nrActives - Number(self.userOptions.selectAll)) {
                let wordForAll = self.userOptions.translations.all;
                selectedTexts = wordForAll;
            } else if (self.multipleSize != -1) {
                if (nrActives > self.multipleSize) {
                    let wordForItems = nrActives === 1 ? self.userOptions.translations.item : self.userOptions.translations.items;
                    selectedTexts = nrActives + ' ' + wordForItems;
                }
            }
            self.title.textContent = selectedTexts;
            self.privateSendChange();
        }
        self.checkUncheckAll();
    }
}

vanillaSelectBox.prototype.privateSendChange = function () {
    let event = document.createEvent('HTMLEvents');
    event.initEvent('change', true, false);
    this.root.dispatchEvent(event);
}

vanillaSelectBox.prototype.empty = function () {
    Array.prototype.slice.call(this.listElements).forEach(function (x) {
        x.classList.remove('active');
    });
    let parentElements = this.drop.querySelectorAll('li.grouped-option');
    if (parentElements) {
        Array.prototype.slice.call(parentElements).forEach(function (x) {
            x.classList.remove('checked');
        });
    }
    this.options.forEach((option) => {
        option.selected = false;
    });
    
    this.title.textContent = '';
    if (this.userOptions.placeHolder != '' && this.title.textContent == '') {
        this.title.textContent = this.userOptions.placeHolder;
    }
    this.checkUncheckAll();
    this.privateSendChange();
    return this;
}

vanillaSelectBox.prototype.destroy = function () {
    let already = document.getElementById(`btn-group-${this.rootToken}`);
    if (already) {
        VSBoxCounter.remove(this.instanceOffset);
        already.remove();
        this.root.classList.remove('vsb-native-select-hidden');
        Array.from(this.root.options).forEach(_option => {
            if (_option.value == 'all') {
                _option.remove();
            }
        });
    }
}

vanillaSelectBox.prototype.disable = function () {
    this.main.addEventListener('click', function (e) {
        e.preventDefault();
        e.stopPropagation();
    });
    let already = document.getElementById(`btn-group-${this.rootToken}`);
    if (already) {
        button = already.querySelector('button')
        if (button) button.classList.add('disabled');
        this.isDisabled = true;
    }
}

vanillaSelectBox.prototype.enable = function () {
    let already = document.getElementById(`btn-group-${this.rootToken}`);
    if (already) {
        button = already.querySelector('button')
        if (button) button.classList.remove('disabled');
        this.isDisabled = false;
    }
}

function vanillaSelectBox_type(target) {
    const computedType = Object.prototype.toString.call(target);
    const stripped = computedType.replace('[object ', '').replace(']', '');
    const lowercased = stripped.toLowerCase();
    return lowercased;
}