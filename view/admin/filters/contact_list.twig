<form action="javascript:void(0);" method="post" class="filter-wrapper list-filter-form" data-action="{{ path }}contact-list">
    <input type="hidden" name="page" value="{{ data.pagination_obj.current }}">
    <div class="params-wrapper">
        <div class="dropdown-toggle" data-toggle-filter></div>
        <div class="tokens-wrapper"></div>
        <div class="search-input-wrapper">
            <input type="text" class="search-input" name="params[key]" value="{{ data.filterParams.key ?? '' }}" placeholder="Ricerca libera..." autocomplete="off">
        </div> 
        <button type="button" class="filter-submit" data-action="submit"></button>
    </div>
    <div class="dropdown-wrapper">
        <div class="form-horizontal">
            <div class="form-group">
                <label class="control-label col-md-3">Provincia</label>
                <div class="col-md-9">
                    <select class="form-control filter-param filter-state" name="params[state]">
                        <option value="" selected="selected">Qualsiasi</option>
                        {% for state in data.state %}
                        <option value="{{ state.nome_provincia }}">{{ state.nome_provincia }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label class="control-label col-md-3">Citt√†</label>
                <div class="col-md-9">
                    <select class="form-control filter-param filter-city" name="params[city]">
                        <option value="">Qualsiasi</option>
                    </select>
                </div>
            </div>
        </div>
        <!-- <button class="submit" data-action="submit">APPLICA FILTRO</button> -->
    </div>
</form>

<script>

document.addEventListener('DOMContentLoaded', function() {
    Delegate(document).on('click', '.filter-submit', function() {
        submitForm();
    });

    Delegate(document).on('change', '.filter-state', function() {
        let state = document.querySelector('.filter-state'); 
        let data = { state:`${state.value}` };
        let removeTags = Array.from(document.querySelectorAll(".filter-param-token")).slice(1);
        removeTags.forEach(function(tag) {
            tag.remove();
        });
        HttpRequest.post(`/api/contact/getCity`, { state:`${state.value}` }, response => {
            if (response.status != 1) {
                throw response.message ?? 'Errore generico';
            }
            console.log(response.result);
            let options = response.result;
            let selectCity = document.querySelector('.filter-city');
            selectCity.innerHTML = '<option value="" selected="selected">Qualsiasi</option>';
            options.forEach(function(option) {
                let optionCity = document.createElement('option');
                optionCity.text = option;
                optionCity.value = option;
                selectCity.appendChild(optionCity);
            });
        });
    });

    const filter = new ToolbarFilter(document.querySelector('.page-toolbar .filter-wrapper'), {
        onSubmit: () => {
            console.log("SUBMIT");
        },
        onInit: (toolbar) => {
            console.log("INIT TOOLBAR");
        }
    });
	
	function submitForm(){
		let key = document.querySelector('.search-input'); 
        let city = document.querySelector('.filter-city'); 
        let state = document.querySelector('.filter-state'); 
        location.href = `/admin/contact-list?key=${key.value}&city=${city.value}&state=${state.value}`;
	}

}); 

</script>