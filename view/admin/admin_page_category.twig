{% extends "index.twig" %}
{% block content %}
<div class="row">
	<div class="col-md-10 col-lg-8">
		<div class="widget">
			<div class="content">
				<fieldset>
					<legend>DATI CATEGORIA</legend>
					<div>
						<form class="form-horizontal admin-page-category-form" action="javascript:void(0);" method="POST">
							{% if data.category.exists() %}
							<input type="hidden" name="params.id" value="{{ data.category.getId() }}">
							{% endif %}
							<div class="form-group">
								<label class="control-label col-md-3">Nome categoria</label>
								<div class="col-md-6">
									<input type="text" name="params.name" class="form-control" value="{{ data.category.getName() }}" required>
								</div>
							</div>
							<div class="form-group">
								<label class="control-label col-md-3">Classe icona</label>
								<div class="col-md-3">
									<input type="text" name="params.icon" class="form-control" value="{{ data.category.getIcon() }}" required>
								</div>
							</div>
							<div class="form-group">
								<label class="control-label col-md-3">Link</label>
								<div class="col-md-9">
									<label class="radio-inline">
										<input type="radio" name="params.is_link" value="1" {{ setCheckbox(data.category.getIsLink(), true) }}> SI
									</label>
									<label class="radio-inline">
										<input type="radio" name="params.is_link" value="0" {{ setCheckbox(data.category.getIsLink(), false) }}> NO
									</label>
								</div>
							</div>
							<div class="form-group">
								<label class="control-label col-md-3">Link esterno</label>
								<div class="col-md-9">
									<label class="radio-inline">
										<input type="radio" name="params.is_external" value="1" {{ setCheckbox(data.category.getIsExternal(), true) }}> SI
									</label>
									<label class="radio-inline">
										<input type="radio" name="params.is_external" value="0" {{ setCheckbox(data.category.getIsExternal(), false) }}> NO
									</label>
								</div>
							</div>
							<div class="form-group">
								<label class="control-label col-md-3">URL</label>
								<div class="col-md-7">
									<input type="text" name="params.url" class="form-control" value="{{ data.category.getUrl() }}" {{ data.category.getIsLink() ? '' : 'readonly' }}>
								</div>
							</div>
							<div class="form-group">
								<label class="control-label col-md-3">Ordine</label>
								<div class="col-md-2">
									<input type="number" name="params.sort" class="form-control" value="{{ data.category.getSort() }}" min="0">
								</div>
							</div>
						</form>					
					</div>
				</fieldset>
			</div>
		</div>		
	</div>
</div>
<script>
	document.addEventListener('DOMContentLoaded', function() {

		Delegate(document).on('change', 'input[name="params.is_link"]', function() {
			document.querySelector('input[name="params.url"]').readOnly = (this.value == '0' && this.checked == true);
		});

		Delegate(document).on('click', '.action.submit', function() {

			const form = document.querySelector('.admin-page-category-form');
			let validator = new FormValidator();
			const validation = validator.checkAll(form);

			if (!validation.valid) {
				validation.fields.forEach(item => {
					if (!item.valid) {
						item.field.closest('.form-group').classList.add('has-error');
					}
				});
				return resAlert.error('Operazione annullata', 'Uno o pi&ugrave; campi non sono stati compilati correttamente');
			}

			const payload = FormSerializer.for(form).serialize();

			this.classList.add('loading');
			HttpRequest.post(`${res.path}admin-page-category/set`, payload, (data, response) => {
				if (data.status !== 1) {
					throw data.message ?? 'Errore generico';
				}
				window.location = `${res.path}admin-page-categories`;
			}, err => resAlert.error('Operazione fallita', err.toString()));
		});

		Delegate(document).on('click', '.action.delete-category', function() {
			if (!confirm('Eliminare questa categoria e le relative pagine ?')) {
				return false;
			}
			this.classList.add('loading');
			HttpRequest.delete(`${res.path}admin-page-category/${this.dataset.id}`, {},
				response => {
					if (response.status == 0) {
						throw response.message ?? 'Errore generico';
					}
					window.location.href = `${res.path}admin-page-categories`;
				}, 
				error => {
					void new resAlert('Operazione fallita', error.toString(), {type:'error'});
				}
			);
		});

	});
</script>
{% endblock content %}