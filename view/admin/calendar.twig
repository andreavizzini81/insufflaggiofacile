{% extends 'index.twig' %}
{% block content %}
<div class="calendar-wrapper"></div>

<style>

@media screen and (max-width: 575.999px) {

    .fc .fc-header-toolbar {
        flex-wrap: wrap;
    }

    .fc .fc-toolbar-chunk {
        flex: 0 0 100%;
    }


}

</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {

        const filter = new ToolbarFilter(document.querySelector('.page-toolbar .filter-wrapper'), {
            onSubmit: () => {
                calHandler.refetchEvents();
            },
            onInit: (toolbar) => {
                const userSelect = toolbar.form.querySelector('select[name="user_id[]"]');+
                void new vanillaSelectBox(userSelect, {
                    ...vsBoxDefaults,
                    placeHolder: 'Nessuna selezione'
                });
            }
        });

        const calHandler = new FullCalendar.Calendar(document.querySelector('.calendar-wrapper'), {
            locale: 'it',
            height: 'auto',
            navLinks: true,
            nowIndicator: true,
            selectMirror: true,
            slotDuration: '00:30:00',
            initialView: 'timeGridWeek',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay,listMonth'
            },
            selectable: false,
            selectConstraint: {
                startTime: '00:00',
                endTime: '23:59'
            },
            views: {
                timeGridWeek: {
                    slotMinTime: '08:00:00',
                    slotMaxTime: '22:00:00'
                },
                timeGridDay: {
                    slotMinTime: '08:00:00',
                    slotMaxTime: '22:00:00'
                }
            },
            loading: function(isLoading, view) {
                this.el.classList.toggle('loading-overlay', isLoading);
            },
            eventClick: function(info) {
                info.el.classList.add('loading');
                const props = info.event.extendedProps;
                void new CalendarEventModal(props.eventId, {
                    endpoint: props.endpoint,
                    onHide: () => {
                        this.refetchEvents();
                    }
                });
            },

            events: function(info, success, failure) {
                const fromDate = moment(info.start).format('YYYY-MM-DD');
                const toDate = moment(info.end).format('YYYY-MM-DD');
                let queryParams = new URLSearchParams(
                    new FormData(filter.form)
                );
                queryParams.set('from', fromDate);
                queryParams.set('to', toDate);

                let url = `${res.absolutePath}api/calendar?${queryParams.toString()}`;
				//let url = `${res.absolutePath}api/calendar`;

                HttpRequest.get(url, (data, response) => {
                    if (data.status !== 1) {
                        failure(data.message ?? 'Errore generico');
                    }
                    success(data.result.list);
                });
            }
        });
        calHandler.render();

    });
</script>
{% endblock content %}